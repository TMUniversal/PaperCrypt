version: "3"

tasks:
  generate:
    desc: Generate the code
    generates:
      - "build_date.gen.txt"
      - "git_ref.gen.txt"
      - "git_commit.gen.txt"
      - "go_version.gen.txt"
      - "os_arch.gen.txt"
      - "os_type.gen.txt"
      - "version.gen.txt"
    sources:
      - "*.go"
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - ".git/HEAD"
      - ".git/refs/heads/*"
      - ".git/refs/tags/*"
    cmds:
      - go generate ./...

  build:
    desc: Build the app
    deps:
      - generate
    sources:
      - "*.go"
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    generates:
      - "bin/papercrypt{{exeExt}}"
    env:
      CGO_ENABLED: "0"
    vars:
      SUMMARY:
        sh: git describe --tags --dirty --always
      BUILT_AT:
        sh: date -u '+%Y-%m-%dT%H:%M:%SZ'
      BUILT_BY: Taskfile
      COMMIT:
        sh: git rev-parse HEAD
      GIT_BRANCH:
        sh: git symbolic-ref --short HEAD 2>/dev/null || git describe --tags --exact-match 2>/dev/null || git rev-parse HEAD
      GIT_TAG:
        sh: git describe --tags --exact-match 2>/dev/null || git rev-parse HEAD
      GIT_DIRTY:
        sh: git diff --quiet || echo "true"
      GO_VERSION:
        sh: go version
      GOOS:
        sh: go env GOOS
      GOARCH:
        sh: go env GOARCH
    cmds:
      - go build --ldflags "-s -w -X main.GoVersion='{{.GO_VERSION}}' -X main.version='{{.SUMMARY}}' -X main.commit='{{.COMMIT}}' -X main.branch='{{.GIT_BRANCH}}' -X main.tag='{{.GIT_TAG}}' -X main.dirty='{{.GIT_DIRTY}}' -X main.date='{{.BUILT_AT}}' -X main.builtBy='{{.BUILT_BY}}' -X main.os='{{.GOOS}}' -X main.arch='{{.GOARCH}}'" -v -o bin/papercrypt{{exeExt}} main.go

  test:
    desc: Run the tests
    deps:
      - build
    vars:
      WITH_COVERAGE: "0"
    cmds:
      - go vet ./...
      - >-
        go test -v ./... -coverprofile=coverage.out -covermode=atomic
        && bash -c 'if [ -n "${WITH_COVERAGE}" ]; then go tool cover -html=coverage.out -o coverage.html; fi'
        && rm coverage.out
      # full pipeline test: generate pdf > extract images > find qr code > read qr code > decode document > compare to input
      # requires pdftoppm, which can be installed with `sudo apt-get install -y poppler-utils`
      # if running on windows, install it in WSL
      - >-
        bash -c 'echo "{\"message\":\"Hello, world!\"}" > test-in.json
        && cat test-in.json
        | bin/papercrypt{{exeExt}} generate --purpose "Test" --comment "Test" --passphrase "test"
        | pdftoppm -png -r 300 - t
        && cat t-1.png
        | bin/papercrypt{{exeExt}} qr
        | bin/papercrypt{{exeExt}} decode -f -o test.json --passphrase "test"
        && diff -u test.json test-in.json
        && echo "Successfully reconstructed input document."
        ; rm -f test.json test-in.json t-*.png'

  release:
    desc: Create a release
    deps:
      - build
      - deps:goreleaser
    cmds:
      - goreleaser release --clean

  reltest:
    desc: Create a release
    deps:
      - build
      - deps:goreleaser
    cmds:
      - goreleaser release --snapshot --clean --skip-publish

  examples:
    desc: Run the examples
    deps:
      - build
      - deps:pdfcpu
    generates:
      - "examples/output.pdf"
      - "examples/no_qr.pdf"
      - "examples/lowercase.pdf"
      - "examples/phrase.pdf"
    cmds:
      - 'bin/papercrypt{{exeExt}} generate -i examples/input.json -o examples/output.pdf    --force --passphrase "example" --purpose "Example Sheet" --comment "Regular PDF Example"                 && pdfcpu validate -m strict examples/output.pdf'
      - 'bin/papercrypt{{exeExt}} generate -i examples/input.json -o examples/no_qr.pdf     --force --passphrase "example" --purpose "Example Sheet" --comment "PDF without QR Code Example" --no-qr && pdfcpu validate -m strict examples/no_qr.pdf'
      - 'bin/papercrypt{{exeExt}} generate -i examples/input.json -o examples/lowercase.pdf --force --passphrase "example" --purpose "Example Sheet" --comment "Lowercase PDF Example" --lowercase   && pdfcpu validate -m strict examples/lowercase.pdf'
      - "bin/papercrypt{{exeExt}} phraseSheet -fo examples/phrase.pdf ExampleAbcA= && pdfcpu validate -m strict examples/phrase.pdf"

  man:
    desc: Generate man pages
    deps:
      - build
    cmds:
      - "bin/papercrypt{{exeExt}} man"

  deps:goreleaser:
    desc: Install goreleaser
    internal: true
    cmds:
      - "goreleaser --version || go install github.com/goreleaser/goreleaser@latest && goreleaser --version"

  standard_version:
    desc: Generate a changelog
    cmds:
      - "npx --yes standard-version"

  clean:
    desc: Remove all generated files
    cmds:
      - "rm -f *.gen.txt"
      - "rm -rf dist bin man"

  clean:examples:
    desc: Remove all generated files
    cmds:
      - "rm -f examples/output.pdf examples/no_qr.pdf examples/lowercase.pdf examples/phrase.pdf"
